---
layout: post
title: Logcabin代码分析1
date: 2018-01-24
author: wuxiangwei
categories: 算法 Raft
tags: 算法 Raft
---

* Kramdown table of content
{:toc, toc}

# Log实现 #

## 接口 ##

### append ###

追加entries到log，返回时新追加的entries可能还没落盘。上层接口使用时，会调用log的sync对象将数据刷入盘。

### getLastLogIndex ###

获取log中最新entry的索引。

### getLogStartIndex ###

获取log中第一条entry的索引。

### truncatePrefix ###

删除给定索引前面的entries。

### truncateSuffix ###

删除给定索引后面的entries。

## MemoryLog ##

### 特点 ###

数据保存在内存，没持久化，进程退出数据丢失；
速度快。

### 思路 ###

使用`std::deque`队列保存entries，实现各接口。

## SimpleFileLog ##

### 特点 ###

### 思路 ###

每条entry都写入到一个单独的文件。
如果把所有entries写到一个文件，要处理比较复杂的分辨entry，异常退出时entry写入不完整等问题。
一个entry写到一个单独的文件，可以避免上述问题。

另外，用单独的文件保存metadata，metadata包含3部分：LogStartIndex、LastLogIndex和版本号。
每次append操作都会将版本号增1，1个版本对应一次append的多条entries。 有两个metadata文件，奇数版本号保存在一个文件，偶数版本号保存在另外一个文件。

## SegmentedLog ##

### 特点 ###

### 思路 ###








